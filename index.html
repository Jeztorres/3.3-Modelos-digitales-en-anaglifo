<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js webgl - effects - anaglyph</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link type="text/css" rel="stylesheet" href="css/main.css">
</head>

<body>
	<div id="info">
		<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> - Modelo 3D con efecto anaglifo<br />
		Usa gafas rojo-azul para ver el efecto 3D<br />
		<strong>Desarrollado por: Jezrael Jared Gomez Torres</strong>
	</div>

	<script type="importmap">
			{
				"imports": {
					"three": "https://unpkg.com/three@0.158.0/build/three.module.js",
					"three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
				}
			}
		</script>

	<script type="module">

		import * as THREE from 'three';

		import { AnaglyphEffect } from 'three/addons/effects/AnaglyphEffect.js';
		import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

		let container, camera, scene, renderer, effect;
		let model, mixer, clock;

		let mouseX = 0;
		let mouseY = 0;

		let windowHalfX = window.innerWidth / 2;
		let windowHalfY = window.innerHeight / 2;

		document.addEventListener('mousemove', onDocumentMouseMove);

		init();

		function init() {

			container = document.createElement('div');
			document.body.appendChild(container);

			camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.01, 1000);
			camera.position.set(0, 2, 5);

			// Crear el reloj para las animaciones
			clock = new THREE.Clock();

			scene = new THREE.Scene();
			// Fondo gris como en la imagen
			scene.background = new THREE.Color(0x808080);

			// Agregar iluminación para el modelo 3D
			const ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
			scene.add(ambientLight);

			const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
			directionalLight.position.set(1, 1, 0).normalize();
			scene.add(directionalLight);

			// Agregar una grilla en el suelo como en la imagen
			const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x444444);
			gridHelper.position.y = -2;
			scene.add(gridHelper);

			// Cargar específicamente Martelo 3.fbx
			const loader = new FBXLoader();

			console.log('Intentando cargar Martelo 3.fbx...');

			loader.load('models/Martelo 3.fbx', function (object) {

				model = object;

				// Ajustar el tamaño y posición del modelo Martelo 3
				model.scale.setScalar(0.01); // Ajustar escala según sea necesario
				model.position.set(0, -2, 0); // Posicionar exactamente en el piso (mismo nivel que la grilla)

				// Configurar materiales del modelo
				model.traverse(function (child) {
					if (child.isMesh) {
						if (child.material) {
							if (Array.isArray(child.material)) {
								child.material.forEach(material => {
									material.needsUpdate = true;
								});
							} else {
								child.material.needsUpdate = true;
							}
						}
					}
				});

				// Configurar animaciones si existen
				if (object.animations && object.animations.length > 0) {
					mixer = new THREE.AnimationMixer(object);

					console.log('Animaciones encontradas:', object.animations.length);
					object.animations.forEach((clip, index) => {
						console.log(`Animación ${index}: ${clip.name}, duración: ${clip.duration}s`);
					});

					// Reproducir la primera animación
					const action = mixer.clipAction(object.animations[0]);
					action.play();

					console.log('Reproduciendo animación:', object.animations[0].name);
				} else {
					console.log('No se encontraron animaciones en el modelo');
				}

				scene.add(model);
				console.log('Modelo Martelo 3.fbx cargado exitosamente!');

			}, function (progress) {
				console.log('Cargando Martelo 3.fbx: ' + (progress.loaded / progress.total * 100) + '%');
			}, function (error) {
				console.error('Error al cargar Martelo 3.fbx:', error);
			});

			//

			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setAnimationLoop(animate);
			container.appendChild(renderer.domElement);

			const width = window.innerWidth || 2;
			const height = window.innerHeight || 2;

			effect = new AnaglyphEffect(renderer);
			effect.setSize(width, height);

			//

			window.addEventListener('resize', onWindowResize);

		}

		function onWindowResize() {

			windowHalfX = window.innerWidth / 2;
			windowHalfY = window.innerHeight / 2;

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			effect.setSize(window.innerWidth, window.innerHeight);

		}

		function onDocumentMouseMove(event) {

			mouseX = (event.clientX - windowHalfX) / 100;
			mouseY = (event.clientY - windowHalfY) / 100;

		}

		//

		function animate() {

			render();

		}

		function render() {

			const delta = clock.getDelta();

			camera.position.x += (mouseX - camera.position.x) * .05;
			camera.position.y += (- mouseY - camera.position.y) * .05;

			camera.lookAt(scene.position);

			// Actualizar animaciones si existen
			if (mixer) {
				mixer.update(delta);
			}

			// El modelo solo reproduce sus animaciones FBX, sin rotación adicional

			effect.render(scene, camera);

		}

	</script>

</body>

</html>